---
title: 'Inefficient Nested Loops'
backlink_href: /docs/query-advisor/insights
backlink_title: 'Query Advisor Insights'
---

Query Advisor detects when Postgres chooses nested loop joins that scan the same table thousands of times unnecessarily, often resulting in dramatically slower performance than alternative join strategies.

## The problem

Sometimes Postgres underestimates how many rows a query will process and chooses nested loop joins that become extremely inefficient. Instead of reading each table once, the query ends up scanning the same table repeatedly.

### Example scenario
<CodeBlock language="sql">
{`SELECT o.*, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE o.order_date >= '2024-01-01';`}
</CodeBlock>

If this query processes 10,000 orders instead of the expected few rows, Postgres may scan the customers table 10,000 times instead of using a more efficient join method.

## How Query Advisor helps

When Query Advisor detects this pattern, it provides optimized query rewrites that force Postgres to use more efficient join strategies.

### Typical optimization approach

Query Advisor may suggest restructuring the query to avoid the problematic nested loops:

<CodeBlock language="sql">
{`WITH filtered_orders AS MATERIALIZED (
  SELECT * FROM orders
  WHERE order_date >= '2024-01-01'
)
SELECT o.*, c.customer_name
FROM filtered_orders o
JOIN customers c ON o.customer_id = c.id;`}
</CodeBlock>

This approach forces Postgres to filter the data first, then join more efficiently, often resulting in 10-100x performance improvements.

## Testing with Workbooks

Use pganalyze Workbooks to validate Query Advisor's suggested optimizations:

1. **Baseline measurement** - Record current query performance
2. **Apply optimization** - Test the suggested rewrite
3. **Compare results** - Verify performance improvements
4. **Validate with different parameters** - Ensure the optimization works consistently

Workbooks provides a safe testing environment to validate optimizations before applying them to production.

## Next steps

- **[See complete example](/docs/query-advisor/from-insight-to-conclusion)** - Full walkthrough of Query Advisor optimization workflow
- **[Configure Workbooks](/docs/workbooks)** - Set up testing environment for validating optimizations
- **[Set up alerts](/docs/query-advisor/alerts)** - Get notified when new optimization opportunities are detected