---
title: 'Set up traceparent query tag within your application'
backlink_href: /docs/collector/otel-setup
backlink_title: 'OpenTelemetry Integration'
---

In order for a tracing span created by the pganalyze collector to correctly
attach to the existing tracing on the application side, the query needs to have
a `traceparent` query tag, as defined in the [W3 Trace Context specification](https://www.w3.org/TR/trace-context/#traceparent-header).

Query tags are key-value pairs appended to SQL statements as query comments.
The pganalyze collector currently supports the following three formats to read
a `traceparent` tag:

* [sqlcommenter](https://google.github.io/sqlcommenter/) format: `key='value'`
* sqlcommenter format without single quotes: `key=value`
* [marginalia](https://github.com/basecamp/marginalia) format: `key:value`

## Add traceparent with Go

### Prerequisite

Set up OpenTelemetry SDK with your application. Read the
[OpenTelemetry documentation](https://opentelemetry.io/docs/instrumentation/go/getting-started/)
for details.

### `database/sql`

The easiest way to add a query tag with Go is to use a drop-in replacement for
go's `database/sql` library, provided by [sqlcommenter](https://google.github.io/sqlcommenter/go/database_sql/).

That library provides an option `EnableTraceparent`: you can enable it to append
a traceparent query tag as a query comment. Please note that this is only
available when you're using OpenTelemetry for your application's tracing too, as
it is going to reference the context and the trace context should be filled by
the application side already.

## Add traceparent with Ruby

### Prerequisite

Set up OpenTelemetry SDK with your application. Read the
[OpenTelemetry documentation](https://opentelemetry.io/docs/instrumentation/ruby/getting-started/)
for details.

### Rails 7+

Rails 7 introduced [Active Record Query Logs](https://api.rubyonrails.org/classes/ActiveRecord/QueryLogs.html)
which automatically appends comments (query tags) to SQL queries.
You can enable this via Rails configuration in `config/application.rb` or an
initializer:

```ruby
config.active_record.query_log_tags_enabled = true
```

By default, this doesn't have a traceparent query tag, so you'll need to add it
manually. New comment tags can be defined by adding them in a `Hash` to the tags
`Array`.
You can append the traceparent tag like the following:

```ruby
config.active_record.query_log_tags = [
  :application,
  :controller,
  :action,
  :job,
  {
    traceparent: -> () {
      current_span = ::OpenTelemetry::Trace.current_span
      return if current_span == ::OpenTelemetry::Trace::Span::INVALID

      span_context = current_span.context
      trace_flag   = span_context.trace_flags.sampled? ? '01' : '00'
      format(
        '00-%<trace_id>s-%<span_id>s-%<trace_flags>.2d',
        trace_id: span_context.hex_trace_id,
        span_id: span_context.hex_span_id,
        trace_flags: trace_flag
      )
    }
  }
]
```

With above configuration, queries will have the comments like the following:

```sql
SELECT "articles".* FROM "articles" /*application='myblog',action='index',controller='articles',traceparent='00-953c157ad37a81d94fe83bb95cfc8add-3cf784b99bd43910-01'*/
```

### Marginalia

If you are using Rails 6 and below, you can attach SQL comments using the
[marginalia](https://github.com/basecamp/marginalia) gem.

You can define a transparent tag in the initializer
(e.g. `config/initializers/marginalia.rb`):

```ruby
module Marginalia
  module Comment
    def self.traceparent
      current_span = ::OpenTelemetry::Trace.current_span
      return if current_span == ::OpenTelemetry::Trace::Span::INVALID

      span_context = current_span.context
      trace_flag   = span_context.trace_flags.sampled? ? '01' : '00'
      format(
        '00-%<trace_id>s-%<span_id>s-%<trace_flags>.2d',
        trace_id: span_context.hex_trace_id,
        span_id: span_context.hex_span_id,
        trace_flags: trace_flag
      )
    end
  end
end

Marginalia::Comment.components = [:application, :controller, :action, :job, :traceparent]
```
